# ═══════════════════════════════════════════════════════════════════════════
# PHASE 1: SECRET POPULATION & CONFIGURATION GENERATION
# ═══════════════════════════════════════════════════════════════════════════
# This section handles:
# - Populating secrets from Bitwarden into template files
# - Merging Kubernetes cluster configurations
# - Generating unified zshrc from modular components

- shell:
    - command: [scripts/populate-secrets.sh]
      description: "Populate secrets from Bitwarden"
      stdout: true
      stderr: true

    - command: [cd kube/clusters && ./merge_clusters.sh]
      stdout: true
      stderr: true

    - command: |
        # Generate zshrc header
        cat > zshrc << 'HEADER'
        #!/bin/zsh
        # ═══════════════════════════════════════════════════════════════════════════
        # ⚠️  AUTOGENERATED FILE - DO NOT EDIT MANUALLY
        # ═══════════════════════════════════════════════════════════════════════════
        # This file is automatically generated during dotfiles installation.
        # To make changes, edit the modular files in ~/.dotfiles/zsh/ instead:
        #   - Core modules: 00-env.zsh through 90-completions.zsh
        #   - OS-specific: os/darwin.zsh, os/linux.zsh
        #   - Distro-specific: distro/ubuntu.zsh, distro/arch.zsh
        # Then run ./install to regenerate this file.
        # ═══════════════════════════════════════════════════════════════════════════

        HEADER

        # Concatenate core modules in order (skip 00-env.zsh - OS detection happens at generation time)
        cat zsh/10-zinit.zsh \
            zsh/20-completion.zsh \
            zsh/30-history.zsh \
            zsh/40-plugins.zsh \
            zsh/50-prompt.zsh \
            zsh/60-exports.zsh \
            zsh/70-aliases.zsh \
            zsh/80-functions.zsh \
            zsh/90-completions.zsh >> zshrc

        # Add OS-specific configuration
        case "$(uname -s)" in
          Darwin)
            echo "" >> zshrc
            echo "# ═══════════════════════════════════════════════════════════════════════════" >> zshrc
            echo "# macOS-specific Configuration" >> zshrc
            echo "# ═══════════════════════════════════════════════════════════════════════════" >> zshrc
            cat zsh/os/darwin.zsh >> zshrc
            ;;
          Linux)
            echo "" >> zshrc
            echo "# ═══════════════════════════════════════════════════════════════════════════" >> zshrc
            echo "# Linux-specific Configuration" >> zshrc
            echo "# ═══════════════════════════════════════════════════════════════════════════" >> zshrc
            cat zsh/os/linux.zsh >> zshrc

            # Detect Linux distro and add distro-specific config
            if [ -f /etc/os-release ]; then
              . /etc/os-release
              case "$ID" in
                ubuntu|debian)
                  echo "" >> zshrc
                  echo "# ─────────────────────────────────────────────────────────────────────────" >> zshrc
                  echo "# Ubuntu/Debian-specific Configuration" >> zshrc
                  echo "# ─────────────────────────────────────────────────────────────────────────" >> zshrc
                  cat zsh/distro/ubuntu.zsh >> zshrc
                  ;;
                arch|manjaro)
                  echo "" >> zshrc
                  echo "# ─────────────────────────────────────────────────────────────────────────" >> zshrc
                  echo "# Arch Linux-specific Configuration" >> zshrc
                  echo "# ─────────────────────────────────────────────────────────────────────────" >> zshrc
                  cat zsh/distro/arch.zsh >> zshrc
                  ;;
              esac
            fi
            ;;
        esac
      description: "Generate unified zshrc from modular components"

# ═══════════════════════════════════════════════════════════════════════════
# PHASE 2: SYMLINK CREATION
# ═══════════════════════════════════════════════════════════════════════════
# This section creates symbolic links from the home directory to configuration
# files in the dotfiles repository. Platform-specific links use conditional
# statements to only create symlinks on the appropriate operating system.

- link:
    ~/.profile: profile
    ~/.bashrc: bashrc
    ~/.bash_logout: bash_logout
    ~/.gitconfig: gitconfig

    ~/.zshrc:
      path: zshrc
      create: true
      relink: true

    ~/.ssh/config:
      if: '[ "$(uname)" = Darwin ]'
      path: macos/ssh/config
      create: true
    ~/.ssh/:
      glob: true
      path: ssh/*
      exclude:
        - ssh/config
        - ssh/.gitkeep
      create: true
      relink: true

    ~/kubectl_aliases: kubectl_aliases

    ~/.config/i3:
      if: '[ "$(uname)" = Linux ]'
      path: config/i3/
      create: true

    ~/.config/sway:
      if: '[ "$(uname)" = Linux ]'
      path: config/sway/
      create: true

    ~/.kube/config:
      path: kube/config
      create: true

    ~/.newsboat/urls:
      path: newsboat/urls
      create: true

    ~/.config/wezterm:
      path: wezterm
      create: true
      relink: true

    ~/.config/atuin:
      path: config/atuin
      create: true

    ~/.config/.gitignore:
      path: gitignore
      create: true

    ~/.config/nvim:
        path: config/nvim
        create: true
        relink: true
        force: true
    ~/.config/k9s:
        path: config/k9s
        create: true
        relink: true
        force: true
    ~/.config/atuin:
        path: config/atuin
        create: true
    ~/.config/lazygit:
        path: config/lazygit
        create: true
    ~/.config/.gitignore:
        path: gitignore
        create: true
    ~/.codex/config.toml:
        path: config/codex/config.toml
        create: true
        force: true
    ~/.ideavimrc: ideavimrc

    ~/.config/starship.toml: starship.toml

    ~/.aerospace.toml:
      if: '[ "$(uname)" = Darwin ]'
      path: config/aerospace.toml
      create: true
      relink: true

    ~/.gradle/gradle.properties: gradle.properties

    ~/.config/yabai:
      if: '[ "$(uname)" = Darwin ]'
      path: config/yabai
      create: true
      relink: true

    ~/.config/skhd:
      if: '[ "$(uname)" = Darwin ]'
      path: config/skhd
      create: true
      relink: true

    ~/.config/spacebar:
      if: '[ "$(uname)" = Darwin ]'
      path: config/spacebar
      create: true
      relink: true

    ~/.config/sketchybar:
      if: '[ "$(uname)" = Darwin ]'
      path: config/sketchybar
      create: true
      relink: true

    # ~/Library/Application\ Support/idasen-controller:
    #   if: '[ "$(uname)" = Darwin ]'
    #   path: idasen-controller
    #   create: true
    #
    # ~/.config/idasen-controller:
    #   if: '[ "$(uname)" = Linux ]'
    #   path: idasen-controller
    #   create: true

# ═══════════════════════════════════════════════════════════════════════════
# PHASE 3: CLEANUP
# ═══════════════════════════════════════════════════════════════════════════
# This section removes dead symbolic links from specified directories to keep
# the configuration clean. Dead links are symlinks that point to non-existent
# files.

- clean:
    ~/.config:
      recursive: true
      force: true

    ~/.kube:
      recursive: true
      force: true

    ~/.ssh:
      force: true
